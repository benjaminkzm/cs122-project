<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>{{ game_name }} – Player Count History</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1"></script>
</head>
<body>
  <header style="text-align: center; margin: 1.5em 0;">
    <h1>{{ game_name }} – Player Count History</h1>
  </header>

  <p style="text-align: center;"><a href="{{ url_for('index') }}">← Back to Search</a></p>

  <!-- Quick Range Selector -->
  <div style="text-align: center; margin: 1em 0;">
    <label>Quick Range:
      <select id="quickRange">
        <option value="1h">Last 1 Hour</option>
        <option value="24h" selected>Last 24 Hours</option>
        <option value="7d">Last 7 Days</option>
      </select>
    </label>
  </div>

  <!-- Manual Date & Hour Picker -->
  <div style="text-align: center; margin: 1em 0;">
    <label>Start:
      <input type="date" id="startDate">
      <select id="startHour"></select>
    </label>
    <label style="margin-left: 1em;">End:
      <input type="date" id="endDate">
      <select id="endHour"></select>
    </label>
    <button id="applyManual" style="margin-left: 1em;">Apply</button>
  </div>

  <!-- Stats Display -->
  <div id="stats" style="text-align: center; font-weight: bold; margin-bottom: 1em;"></div>

  <!-- Chart Canvas -->
  <div style="width: 90%; max-width: 800px; margin: auto;">
    <canvas id="chart"></canvas>
  </div>

  <script>
    /* eslint-disable */
    const APPID = {{ appid }};
    const NOW   = luxon.DateTime.now();

    // build Chart.js
    const ctx = document.getElementById("chart").getContext("2d");
    const chart = new Chart(ctx, {
      type: "line",
      data: {
        datasets: [{
          label: "{{ game_name }}",
          data: []
        }]
      },
      options: {
        parsing: { xAxisKey: "t", yAxisKey: "y" },
        scales: {
          x: { type: "time", time: { tooltipFormat: "MMM d, HH:mm" } },
          y: { beginAtZero: true }
        }
      }
    });

    // hour dropdowns
    ["startHour", "endHour"].forEach(id => {
      const sel = document.getElementById(id);
      for (let h = 0; h < 24; h++) {
        const opt = document.createElement("option");
        const hh  = String(h).padStart(2, "0");
        opt.value = hh;
        opt.text  = hh + ":00";
        sel.appendChild(opt);
      }
    });

    async function loadRange(range) {
      let start, end = luxon.DateTime.now();

      if (range) {
        if (range === "1h") start = NOW.minus({ hours: 1 });
        else if (range === "7d") start = NOW.minus({ days: 7 });
        else start = NOW.minus({ days: 1 });
      } else {
        const d1 = document.getElementById("startDate").value;
        const h1 = document.getElementById("startHour").value;
        const d2 = document.getElementById("endDate").value;
        const h2 = document.getElementById("endHour").value;
        start = luxon.DateTime.fromISO(`${d1}T${h1}:00`);
        end   = luxon.DateTime.fromISO(`${d2}T${h2}:00`);
      }

      const sISO = encodeURIComponent(start.toISO());
      const eISO = encodeURIComponent(end.toISO());
      const res  = await fetch(`/api/history/${APPID}?start=${sISO}&end=${eISO}`);
      const data = await res.json();

      chart.data.datasets[0].data = data.map(d => ({ t: d.timestamp, y: d.count }));
      chart.update();

      const statsEl = document.getElementById("stats");
      if (data.length) {
        const counts = data.map(d => d.count);
        const min = Math.min(...counts);
        const max = Math.max(...counts);
        const avg = (counts.reduce((a,b) => a + b, 0) / counts.length).toFixed(1);
        statsEl.textContent = `Min: ${min}, Max: ${max}, Avg: ${avg}`;
      } else {
        statsEl.textContent = "No data in this range.";
      }
    }

    // events
    document.getElementById("quickRange").addEventListener("change", e => {
      const r = e.target.value;
      const start = r === "1h"
        ? NOW.minus({ hours: 1 })
        : r === "7d"
          ? NOW.minus({ days: 7 })
          : NOW.minus({ days: 1 });

      document.getElementById("startDate").value = start.toISODate();
      document.getElementById("startHour").value = start.toFormat("HH");
      document.getElementById("endDate").value   = NOW.toISODate();
      document.getElementById("endHour").value   = NOW.toFormat("HH");
      loadRange(r);
    });

    document.getElementById("applyManual").addEventListener("click", () => loadRange(null));

    window.addEventListener("load", () => {
      document.getElementById("quickRange").value = "24h";
      document.getElementById("quickRange").dispatchEvent(new Event("change"));
      setInterval(() => loadRange(document.getElementById("quickRange").value), 300000);
    });
  </script>
</body>
</html>
