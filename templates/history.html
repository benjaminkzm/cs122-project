<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>{{ game_name }} – Player Count History</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <!-- Chart.js & Luxon -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1"></script>
</head>
<body>
  <header style="text-align: center; margin: 1.5em 0;">
    <h1>{{ game_name }} – Player Count History</h1>
  </header>

  <p style="text-align: center;"><a href="{{ url_for('index') }}">← Back to Search</a></p>

  <!-- Quick Range Selector -->
  <div style="text-align: center; margin: 1em 0;">
    <label>Quick Range:
      <select id="quickRange">
        <option value="1h">Last 1 Hour</option>
        <option value="24h" selected>Last 24 Hours</option>
        <option value="7d">Last 7 Days</option>
      </select>
    </label>
  </div>

  <!-- Manual Date & Hour Picker -->
  <div style="text-align: center; margin: 1em 0;">
    <label>Start:
      <input type="date" id="startDate">
      <select id="startHour"></select>
    </label>
    <label style="margin-left: 1em;">End:
      <input type="date" id="endDate">
      <select id="endHour"></select>
    </label>
    <button id="applyManual" style="margin-left: 1em;">Apply</button>
  </div>

  <!-- Stats Display -->
  <div id="stats" style="text-align: center; font-weight: bold; margin-bottom: 1em;"></div>

  <!-- Chart Container -->
  <div style="width: 90%; max-width: 800px; margin: auto;">
    <canvas id="chart"></canvas>
  </div>

  <script>
    var appid = parseInt("{{ appid }}", 10);
    const chartCtx = document.getElementById('chart').getContext('2d');
    const now = luxon.DateTime.now();

    // Initialize Chart.js
    const chart = new Chart(chartCtx, {
      type: 'line',
      data: { datasets: [{ label: '{{ game_name }}', data: [] }] },
      options: {
        parsing: { xAxisKey: 't', yAxisKey: 'y' },
        scales: {
          x: { type: 'time', time: { tooltipFormat: 'MMM d, HH:mm' } },
          y: { beginAtZero: true }
        }
      }
    });

    // Populate hour dropdowns (00 to 23)
    function initHourSelect(id) {
      const select = document.getElementById(id);
      for (let h = 0; h < 24; h++) {
        const opt = document.createElement('option');
        const val = h.toString().padStart(2, '0');
        opt.value = val;
        opt.text = val + ':00';
        select.appendChild(opt);
      }
    }
    initHourSelect('startHour');
    initHourSelect('endHour');

    // Load data by range string or manual pick
    async function loadRange(range) {
      let start, end;
      const now = luxon.DateTime.now();
      if (range) {
        if (range === '1h') start = now.minus({ hours: 1 });
        else if (range === '24h') start = now.minus({ days: 1 });
        else if (range === '7d') start = now.minus({ days: 7 });
        end = now;
      } else {
        // Manual selection
        const sd = document.getElementById('startDate').value;
        const sh = document.getElementById('startHour').value;
        const ed = document.getElementById('endDate').value;
        const eh = document.getElementById('endHour').value;
        start = luxon.DateTime.fromISO(`${sd}T${sh}:00`);
        end   = luxon.DateTime.fromISO(`${ed}T${eh}:00`);
      }
      const startISO = encodeURIComponent(start.toISO());
      const endISO   = encodeURIComponent(end.toISO());

      const res = await fetch(`/api/history/${appid}?start=${startISO}&end=${endISO}`);
      const data = await res.json();
      chart.data.datasets[0].data = data.map(d => ({ t: d.timestamp, y: d.count }));
      chart.update();

      if (data.length) {
        const counts = data.map(d => d.count);
        const min = Math.min(...counts);
        const max = Math.max(...counts);
        const avg = (counts.reduce((a,b)=>a+b,0)/counts.length).toFixed(1);
        document.getElementById('stats').textContent = `Min: ${min}, Max: ${max}, Avg: ${avg}`;
      } else {
        document.getElementById('stats').textContent = 'No data in this range.';
      }
    }

    // Event listeners
    document.getElementById('quickRange').addEventListener('change', e => {
      // update manual picks
      const range = e.target.value;
      const start = (range==='1h'? now.minus({hours:1}) : range==='24h'? now.minus({days:1}) : now.minus({days:7}));
      document.getElementById('startDate').value = start.toISODate();
      document.getElementById('startHour').value = start.toFormat('HH');
      document.getElementById('endDate').value = now.toISODate();
      document.getElementById('endHour').value = now.toFormat('HH');
      loadRange(range);
    });

    document.getElementById('applyManual').addEventListener('click', () => loadRange(null));

    // On load
    window.addEventListener('load', () => {
      // init manual picks to last 24h
      document.getElementById('quickRange').value = '24h';
      document.getElementById('quickRange').dispatchEvent(new Event('change'));
      // auto-refresh
      setInterval(() => loadRange(document.getElementById('quickRange').value), 300000);
    });
  </script>
</body>
</html>
