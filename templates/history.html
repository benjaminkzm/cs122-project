<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>{{ game_name }} – Player Count History</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <!-- Chart.js & Luxon -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1"></script>
</head>
<body>
  <header style="text-align: center; margin: 1.5em 0;">
    <h1>{{ game_name }} – Player Count History</h1>
  </header>

  <p style="text-align: center;"><a href="{{ url_for('index') }}">← Back to Search</a></p>

  <!-- Quick Range Selector -->
  <div style="text-align: center; margin: 1em 0;">
    <label>Quick Range:
      <select id="quickRange">
        <option value="1h">Last 1 Hour</option>
        <option value="24h" selected>Last 24 Hours</option>
        <option value="7d">Last 7 Days</option>
      </select>
    </label>
  </div>

  <!-- Date Pickers -->
  <div style="text-align: center; margin: 1em 0;">
    <label>Start:
      <input type="date" id="startDate" value="{{ default_start }}">
    </label>
    <label style="margin-left: 1em;">End:
      <input type="date" id="endDate" value="{{ default_end }}">
    </label>
    <button id="apply" style="margin-left: 1em;">Apply</button>
  </div>

  <!-- Stats Display -->
  <div id="stats" style="text-align: center; font-weight: bold; margin-bottom: 1em;"></div>

  <!-- Chart Container -->
  <div style="width: 90%; max-width: 800px; margin: auto;">
    <canvas id="chart"></canvas>
  </div>

  <script>
    var appid = parseInt("{{ appid }}", 10);
    const chartCtx = document.getElementById('chart').getContext('2d');

    // Initialize Chart.js
    const chart = new Chart(chartCtx, {
      type: 'line',
      data: { datasets: [{ label: '{{ game_name }}', data: [] }] },
      options: {
        parsing: { xAxisKey: 't', yAxisKey: 'y' },
        scales: {
          x: { type: 'time', time: { tooltipFormat: 'MMM d, HH:mm' } },
          y: { beginAtZero: true }
        }
      }
    });

    // Fetch and render data
    async function fetchData() {
      const start = document.getElementById('startDate').value;
      const end = document.getElementById('endDate').value;
      const res = await fetch(`/api/history/${appid}?start=${start}&end=${end}`);
      const data = await res.json();
      // Update chart
      chart.data.datasets[0].data = data.map(d => ({ t: d.timestamp, y: d.count }));
      chart.update();
      // Update stats
      if (data.length) {
        const counts = data.map(d => d.count);
        const min = Math.min(...counts);
        const max = Math.max(...counts);
        const avg = (counts.reduce((a,b) => a+b,0)/counts.length).toFixed(1);
        document.getElementById('stats').textContent =
          `Min: ${min}, Max: ${max}, Avg: ${avg}`;
      } else {
        document.getElementById('stats').textContent = 'No data in this range.';
      }
    }

    // Quick range setter using Luxon
    function setQuickRange(range) {
      const now = luxon.DateTime.now();
      let start;
      if (range === '1h') start = now.minus({ hours: 1 });
      else if (range === '24h') start = now.minus({ days: 1 });
      else if (range === '7d') start = now.minus({ days: 7 });
      document.getElementById('startDate').value = start.toISODate();
      document.getElementById('endDate').value = now.toISODate();
      fetchData();
    }

    // Event listeners
    document.getElementById('quickRange')
      .addEventListener('change', e => setQuickRange(e.target.value));
    document.getElementById('apply')
      .addEventListener('click', fetchData);

    // Auto-refresh interval (5 min)
    setInterval(fetchData, 300000);

    // On load, initialize inputs and load 24h data
    window.addEventListener('load', () => setQuickRange('24h'));
  </script>
</body>
</html>
